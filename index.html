<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아빠의 수학 퀴즈 여행</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-button {
            background-color: #5a2e9b;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .menu-button:hover {
            background-color: #4a257e;
            transform: translateY(-2px);
        }

        .quiz-section {
            display: none;
            text-align: left;
        }

        .question-box {
            background: #f7f7f7;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .question-display-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feedback {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
            min-height: 25px;
        }

        .correct {
            color: #28a745;
        }

        .wrong {
            color: #dc3545;
        }
        
        /* 풀이 설명 스타일 */
        .explanation-box {
            background-color: #e9eef6;
            border-left: 5px solid #5a2e9b;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            border-radius: 8px;
            display: none; /* 초기에는 숨김 */
            font-size: 1em;
            color: #333;
            line-height: 1.6;
        }

        .explanation-box h4 {
            margin-bottom: 10px;
            color: #4a257e;
        }
        
        .explanation-step {
            margin-bottom: 8px;
        }

        .score-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #eee;
            border-radius: 50px;
            margin-top: 15px;
        }

        .progress-bar {
            height: 15px;
            background-color: #5a2e9b;
            border-radius: 50px;
            transition: width 0.5s ease;
        }

        .about-section, .records-section, .multiplication-table-section {
            display: none;
            text-align: left;
            padding: 20px;
        }
        
        /* 앱 정보 페이지 정렬 */
        #aboutView {
            display: none;
            flex-direction: column;
            align-items: center; /* 수평 중앙 정렬 */
            text-align: center; /* 텍스트 중앙 정렬 */
        }
        
        .record-item {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .records-section h2, .about-section h2, .multiplication-table-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .records-section h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #4a257e;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .select-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .select-group {
            text-align: left;
        }
        
        /* 퀴즈 설정 페이지 정렬 및 스타일 개선 */
        #quizSettingsView {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        #quizSettingsView .section-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 30px;
        }
        
        #quizSettingsView .select-container {
            width: 100%;
            max-width: 400px; /* 드롭다운 그룹의 최대 너비 */
            margin-bottom: 30px;
        }
        
        #quizSettingsView .select-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        
        #quizSettingsView .select-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        #quizSettingsView .input-field {
            width: 100%;
        }
        
        #quizSettingsView .menu-button {
            width: 100%;
            max-width: 300px; /* 버튼의 최대 너비 */
            margin-bottom: 10px;
        }

        .vertical-problem {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2em;
            line-height: 1.2;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            width: fit-content;
        }

        .vertical-line {
            border-bottom: 2px solid #333;
            width: 100%;
        }

        .vertical-row {
            padding-right: 5px;
        }

        .operator {
            display: inline-block;
            margin-right: 5px;
        }
        
        .name-history {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: -5px;
            margin-bottom: 15px;
        }
        
        .name-tag {
            background-color: #e0e0e0;
            border-radius: 12px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .name-tag:hover {
            background-color: #d0d0d0;
        }
        
        .name-tag .delete-btn {
            background: transparent;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            color: #888;
            padding: 0;
            line-height: 1;
        }
        
        .name-tag .delete-btn:hover {
            color: #333;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">아빠의 수학 퀴즈 여행</h1>

        <div class="menu" id="mainMenu">
            <h2 class="section-title">윤하! 하윤! 노력해서 보여줘!!</h2>
            <label for="userName" style="font-weight: bold; margin-bottom: 5px; display: block;">퀴즈를 시작하기 전에 이름을 입력해주세요.</label>
            <input type="text" id="userName" class="input-field" placeholder="이름을 입력하세요">
            <div id="nameHistoryContainer" class="name-history"></div>
            <button class="menu-button" onclick="goToSettings()">퀴즈 시작</button>
            <button class="menu-button" onclick="showMultiplicationTable()">구구단 표 보기</button>
            <button class="menu-button" onclick="showRecords()">기록 보기</button>
            <button class="menu-button" onclick="showAbout()">앱 정보</button>
        </div>

        <div class="quiz-section" id="quizSettingsView">
            <h2 id="settingsTitle" class="section-title"></h2>
            <div class="select-container">
                <div class="select-group">
                    <label for="problemType">문제 유형 선택:</label>
                    <select id="problemType" class="input-field">
                        <option value="전체">전체</option>
                        <option value="덧셈">덧셈</option>
                        <option value="뺄셈">뺄셈</option>
                        <option value="곱셈">곱셈</option>
                        <option value="나눗셈">나눗셈</option>
                        <option value="혼합">혼합</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="difficulty">난이도 선택:</label>
                    <select id="difficulty" class="input-field">
                        <option value="F">F (아주 쉬운)</option>
                        <option value="E">E (쉬움)</option>
                        <option value="D">D (보통)</option>
                        <option value="C">C (조금 어려움)</option>
                        <option value="B">B (어려움)</option>
                        <option value="A">A (매우 어려움)</option>
                        <option value="S">S (최상급)</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="questionCount">문제 개수 선택:</label>
                    <select id="questionCount" class="input-field">
                        <option value="5">5개</option>
                        <option value="10">10개</option>
                        <option value="20">20개</option>
                        <option value="30">30개</option>
                    </select>
                </div>
            </div>
            <button class="menu-button" onclick="beginQuiz()">퀴즈 시작</button>
            <button class="menu-button" onclick="showMainMenu()">메인 메뉴로</button>
        </div>

        <div class="quiz-section" id="quizView">
            <h2 id="quizTitle" class="section-title"></h2>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="question-box">
                <div class="question-display-container">
                    <p id="questionText" class="question-text"></p>
                    <div id="verticalProblem" class="vertical-problem"></div>
                </div>
                
                <input type="number" id="answerInput" class="answer-input" placeholder="정답을 입력하세요">
                
                <div class="button-container">
                    <button id="checkAnswerBtn" class="menu-button" onclick="checkAnswer()">정답 확인</button>
                    <button id="nextQuestionBtn" class="menu-button" onclick="goToNextQuestion()" style="display: none;">다음 문제</button>
                </div>

                <p id="feedback" class="feedback"></p>
                <div id="explanationBox" class="explanation-box"></div>
            </div>
            <div id="quizScore" class="score-display">점수: 0</div>
            <button class="menu-button" onclick="showMainMenu()">메인 메뉴로</button>
        </div>

        <div class="quiz-section" id="recordsView">
            <h2 class="section-title">퀴즈 기록</h2>
            <div id="recordsContainer"></div>
            <button class="menu-button" onclick="showMainMenu()">메인 메뉴로</button>
            <button class="menu-button" onclick="resetRecords()">기록 리셋</button>
        </div>

        <div class="quiz-section" id="aboutView">
            <h2 class="section-title" style="text-align: center;">앱 정보</h2>
            <p style="text-align: center; margin-bottom: 20px;">
                이 앱은 윤하 와 하윤이의 연산 수학 실력 향상을 위해 만들어 졌습니다. 아빠는 마리셀, 윤하, 하윤이 모두를 사랑합니다!^^
            </p>
            <button class="menu-button" style="display: block; margin: 0 auto;" onclick="showMainMenu()">메인 메뉴로</button>
        </div>

        <div class="quiz-section" id="multiplicationTableView">
            <h2 class="section-title">구구단 표</h2>
            <div id="multiplicationTableContainer" style="text-align: center;"></div>
            <button class="menu-button" onclick="showMainMenu()">메인 메뉴로</button>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        let quizQuestions = [];
        let userName = '';
        const records = JSON.parse(localStorage.getItem('quizRecords')) || [];
        let questionsPerQuiz = 10;
        let startTime;
        let userNames = JSON.parse(localStorage.getItem('userNames')) || [];

        const difficultyRanges = {
            'F': { numMin: 1, numMax: 9, ops: ['+', '-', '*'] },
            'E': { numMin: 10, numMax: 99, ops: ['+', '-', '*'] },
            'D': { numMin: 10, numMax: 99, ops: ['+', '-', '*', '/'] },
            'C': { numMin: 100, numMax: 999, ops: ['+', '-', '*'] },
            'B': { numMin: 100, numMax: 999, ops: ['+', '-', '*', '/'] },
            'A': { numMin: 100, numMax: 9999, ops: ['+', '-', '*', '/'] },
            'S': { numMin: 1000, numMax: 99999, ops: ['+', '-', '*'] }
        };

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateRandomProblem(type, difficulty) {
            const config = difficultyRanges[difficulty];
            let problem = { text: '', answer: 0, type: type, grade: difficulty };

            if (type === '전체') {
                const availableTypes = ['덧셈', '뺄셈', '곱셈', '나눗셈', '혼합'];
                type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            }
            
            if (type === '혼합') {
                const op1 = config.ops[Math.floor(Math.random() * config.ops.length)];
                const op2 = config.ops[Math.floor(Math.random() * config.ops.length)];
                let n1, n2, n3;

                switch(difficulty) {
                    case 'F':
                    case 'E':
                    case 'D':
                        n1 = getRandomInt(1, 10);
                        n2 = getRandomInt(1, 10);
                        n3 = getRandomInt(1, 10);
                        break;
                    case 'C':
                    case 'B':
                        n1 = getRandomInt(10, 50);
                        n2 = getRandomInt(1, 20);
                        n3 = getRandomInt(1, 15);
                        break;
                    case 'A':
                        n1 = getRandomInt(50, 200);
                        n2 = getRandomInt(10, 50);
                        n3 = getRandomInt(5, 20);
                        break;
                    case 'S':
                        n1 = getRandomInt(100, 500);
                        n2 = getRandomInt(50, 100);
                        n3 = getRandomInt(10, 50);
                        break;
                }

                problem.text = `${n1} ${op1} ${n2} ${op2} ${n3}`;
                // 안전하게 answer를 계산하기 위해 eval 사용
                problem.answer = eval(problem.text);
                
                // 혼합 문제에서 나눗셈이 사용되고 정수가 아닐 경우, 정수가 될 때까지 재생성
                if (problem.text.includes('/') && problem.answer !== Math.floor(problem.answer)) {
                    return generateRandomProblem('혼합', difficulty);
                }

            } else {
                let num1, num2;
                if (type === '나눗셈') {
                    num2 = getRandomInt(2, 12);
                    num1 = num2 * getRandomInt(1, 12);
                    
                    if (difficulty === 'D') {
                       num2 = getRandomInt(2, 9);
                       num1 = num2 * getRandomInt(10, 20);
                    } else if (difficulty === 'B') {
                       num2 = getRandomInt(10, 20);
                       num1 = num2 * getRandomInt(10, 30);
                    } else if (difficulty === 'A') {
                       num2 = getRandomInt(20, 50);
                       num1 = num2 * getRandomInt(20, 50);
                    } else if (difficulty === 'S') {
                       num2 = getRandomInt(50, 100);
                       num1 = num2 * getRandomInt(50, 100);
                    }
                } else {
                    num1 = getRandomInt(config.numMin, config.numMax);
                    num2 = getRandomInt(config.numMin, config.numMax);
                }

                const operator = {
                    '덧셈': '+',
                    '뺄셈': '-',
                    '곱셈': '*',
                    '나눗셈': '/'
                }[type];

                if (type === '뺄셈' && num2 > num1) {
                    [num1, num2] = [num2, num1];
                }
                
                problem.text = `${num1} ${operator} ${num2}`;
                problem.answer = eval(problem.text);
            }
            return problem;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.quiz-section, .menu').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'flex';
            if (sectionId === 'quizView' || sectionId === 'multiplicationTableView' || sectionId === 'recordsView' || sectionId === 'aboutView') {
                document.getElementById(sectionId).style.flexDirection = 'column';
            }
        }

        function showMainMenu() {
            document.getElementById('userName').value = userName;
            showSection('mainMenu');
            updateNameHistory();
        }
        
        // 이름 목록을 표시하는 함수
        function updateNameHistory() {
            const container = document.getElementById('nameHistoryContainer');
            container.innerHTML = '';
            userNames.forEach(name => {
                const nameTag = document.createElement('div');
                nameTag.className = 'name-tag';
                nameTag.innerText = name;
                nameTag.onclick = () => {
                    document.getElementById('userName').value = name;
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerText = '×';
                deleteBtn.onclick = (event) => {
                    event.stopPropagation(); // 부모 클릭 이벤트 방지
                    deleteName(name);
                };
                
                nameTag.appendChild(deleteBtn);
                container.appendChild(nameTag);
            });
        }
        
        // 이름을 삭제하는 함수
        function deleteName(nameToDelete) {
            userNames = userNames.filter(name => name !== nameToDelete);
            localStorage.setItem('userNames', JSON.stringify(userNames));
            updateNameHistory();
        }

        function goToSettings() {
            userName = document.getElementById('userName').value.trim();
            if (userName === '') {
                alert('이름을 입력해주세요!');
                return;
            }
            
            // 새로운 이름이면 추가하고 저장
            if (!userNames.includes(userName)) {
                userNames.push(userName);
                localStorage.setItem('userNames', JSON.stringify(userNames));
            }

            document.getElementById('settingsTitle').innerText = `${userName}님, 퀴즈 설정을 선택하세요!`;
            showSection('quizSettingsView');
        }

        function beginQuiz() {
            const selectedType = document.getElementById('problemType').value;
            const selectedDifficulty = document.getElementById('difficulty').value;
            questionsPerQuiz = parseInt(document.getElementById('questionCount').value);

            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = generateQuizQuestions(selectedType, selectedDifficulty);
            startTime = new Date();
            updateQuizUI();
            showSection('quizView');
            document.getElementById('quizTitle').innerText = `${userName}님의 퀴즈 (${selectedDifficulty} 난이도)`;
        }

        function generateQuizQuestions(type, difficulty) {
            const questions = [];
            for(let i = 0; i < questionsPerQuiz; i++) {
                questions.push(generateRandomProblem(type, difficulty));
            }
            return questions;
        }
        
        function createVerticalProblemHTML(questionText) {
            const parts = questionText.split(/([+\-*/])/);
            const num1 = parts[0].trim();
            const operator = parts[1].trim();
            const num2 = parts[2].trim();
            
            let html = '';

            if (operator === '/') {
                // 나눗셈을 위한 특별한 세로셈
                html = `
                    <div class="vertical-row">${num1}</div>
                    <div class="vertical-row"><span class="operator">÷</span>${num2}</div>
                    <div class="vertical-line"></div>
                `;
            } else {
                // 기존의 덧셈, 뺄셈, 곱셈 세로셈
                html = `
                    <div class="vertical-row">${num1}</div>
                    <div class="vertical-row"><span class="operator">${operator}</span>${num2}</div>
                    <div class="vertical-line"></div>
                `;
            }
            
            return html;
        }

        function updateQuizUI() {
            if (currentQuestionIndex < quizQuestions.length) {
                const currentQuestion = quizQuestions[currentQuestionIndex];
                document.getElementById('questionText').innerText = currentQuestion.text;
                
                const verticalProblemDiv = document.getElementById('verticalProblem');
                // 나눗셈 문제에도 세로셈을 적용
                if (['덧셈', '뺄셈', '곱셈', '나눗셈'].includes(currentQuestion.type)) {
                    verticalProblemDiv.innerHTML = createVerticalProblemHTML(currentQuestion.text);
                    verticalProblemDiv.style.display = 'flex';
                } else {
                    verticalProblemDiv.innerHTML = '';
                    verticalProblemDiv.style.display = 'none';
                }

                document.getElementById('answerInput').value = '';
                document.getElementById('feedback').innerText = '';
                document.getElementById('explanationBox').style.display = 'none'; // 다음 문제로 넘어가면 풀이 숨김
                document.getElementById('quizScore').innerText = `점수: ${score}`;
                
                document.getElementById('checkAnswerBtn').style.display = 'block';
                document.getElementById('nextQuestionBtn').style.display = 'none';

                const progress = (currentQuestionIndex / quizQuestions.length) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            } else {
                endQuiz();
            }
        }

        function checkAnswer() {
            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const currentQuestion = quizQuestions[currentQuestionIndex];
            const feedbackElement = document.getElementById('feedback');
            const explanationBox = document.getElementById('explanationBox');
            
            if (userAnswer === currentQuestion.answer) {
                feedbackElement.innerText = '정답입니다! 😊';
                feedbackElement.className = 'feedback correct';
                score += 10;
                explanationBox.style.display = 'none';
            } else {
                feedbackElement.innerText = `아쉽네요. 정답은 ${currentQuestion.answer}입니다.`;
                feedbackElement.className = 'feedback wrong';
                explanationBox.innerHTML = `<h4>문제 풀이</h4>${generateExplanation(currentQuestion)}`;
                explanationBox.style.display = 'block';
            }

            document.getElementById('checkAnswerBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'block';
        }

        function generateExplanation(question) {
            const parts = question.text.split(/([+\-*/])/);
            const num1 = parseFloat(parts[0].trim());
            const operator = parts[1].trim();
            const num2 = parseFloat(parts[2].trim());
            
            let explanation = '';
            let tip = '';

            switch (operator) {
                case '+':
                    let n1_temp = num1;
                    let n2_temp = num2;
                    let sum = 0;
                    let carry = 0;
                    let i = 0;

                    explanation += `<div class="explanation-step"><strong>${num1} + ${num2}</strong>를 계산해봅시다.</div>`;

                    while (n1_temp > 0 || n2_temp > 0 || carry > 0) {
                        const d1 = n1_temp % 10;
                        const d2 = n2_temp % 10;
                        const digitSum = d1 + d2 + carry;
                        
                        explanation += `<div class="explanation-step"><strong>${10**i}의 자리:</strong> ${d1} + ${d2} + ${carry}(올림) = ${digitSum}입니다.</div>`;

                        if (digitSum >= 10) {
                            carry = Math.floor(digitSum / 10);
                            explanation += `<div class="explanation-step"><strong>${10**(i+1)}의 자리로 ${carry}를 올립니다.</strong></div>`;
                        } else {
                            carry = 0;
                        }
                        
                        sum = (digitSum % 10) * (10**i) + sum;
                        n1_temp = Math.floor(n1_temp / 10);
                        n2_temp = Math.floor(n2_temp / 10);
                        i++;
                    }
                    explanation += `<div class="explanation-step">최종 결과는 ${sum}입니다.</div>`;
                    tip = '덧셈은 오른쪽부터 시작해서 한 자리씩 더하고, 합이 10이 넘으면 다음 자리로 올림하는 것이 핵심입니다.';
                    break;
                case '-':
                    let n1_str = num1.toString();
                    let n2_str = num2.toString();
                    let result_str = '';
                    let borrow = 0;

                    const maxLength = Math.max(n1_str.length, n2_str.length);
                    n1_str = n1_str.padStart(maxLength, '0');
                    n2_str = n2_str.padStart(maxLength, '0');
                    
                    explanation += `<div class="explanation-step"><strong>${num1} - ${num2}</strong>를 계산해봅시다.</div>`;
                    
                    for (let i = maxLength - 1; i >= 0; i--) {
                        let d1 = parseInt(n1_str[i]);
                        let d2 = parseInt(n2_str[i]);
                        
                        let diff = d1 - d2 - borrow;
                        
                        explanation += `<div class="explanation-step"><strong>${10**(maxLength - 1 - i)}의 자리:</strong> ${d1} - ${d2} - ${borrow}(받아내림) = ${diff}입니다.</div>`;
                        
                        if (diff < 0) {
                            diff += 10;
                            borrow = 1;
                            explanation += `<div class="explanation-step"><strong>왼쪽 자리에서 10을 받아내립니다.</strong></div>`;
                        } else {
                            borrow = 0;
                        }
                        result_str = diff.toString() + result_str;
                    }
                    
                    explanation += `<div class="explanation-step">최종 결과는 ${question.answer}입니다.</div>`;
                    tip = '뺄셈은 자리가 부족할 때 왼쪽 자리에서 10을 빌려오는 **받아내림**을 정확히 해야 합니다.';
                    break;
                case '*':
                    const n1_str_m = num1.toString();
                    const n2_str_m = num2.toString();
                    
                    explanation += `<div class="explanation-step"><strong>${num1} x ${num2}</strong>를 계산해봅시다.</div>`;
                    
                    for (let i = n2_str_m.length - 1; i >= 0; i--) {
                        const currentDigit = parseInt(n2_str_m[i]);
                        const partialProduct = num1 * currentDigit;
                        
                        explanation += `<div class="explanation-step"><strong>1단계:</strong> ${num1} x ${currentDigit} = ${partialProduct}입니다.</div>`;
                    }
                    
                    explanation += `<div class="explanation-step"><strong>2단계:</strong> 각 곱셈 결과를 자리에 맞춰 더합니다.</div>`;
                    explanation += `<div class="explanation-step">최종 결과는 ${question.answer}입니다.</div>`;
                    tip = '곱셈은 곱하는 수의 각 자리 수와 순서대로 곱한 뒤, 자리를 맞춰 더하는 과정이 중요합니다.';
                    break;
                case '/':
                    const remainder = num1 % num2;
                    const quotient = Math.floor(num1 / num2);
                    explanation = `
                        <div class="explanation-step"><strong>${num1} ÷ ${num2}</strong>를 계산해봅시다.</div>
                        <div class="explanation-step"><strong>1단계:</strong> ${num1} 안에 ${num2}가 몇 번 들어가는지 확인합니다.</div>
                        <div class="explanation-step"><strong>2단계:</strong> 몫은 ${quotient}이고, 나머지는 ${remainder}입니다.</div>
                        <div class="explanation-step">따라서 ${num1} ÷ ${num2}의 정답은 몫인 ${question.answer}입니다.</div>
                    `;
                    tip = '나눗셈은 몫과 나머지를 정확히 구분하는 것이 중요합니다. 나머지가 없는지 확인하세요.';
                    break;
                default: // 혼합 계산
                    // 정규식을 사용하여 연산자와 숫자를 분리
                    const mixed_parts = question.text.match(/(\d+)\s*([+\-*/])\s*(\d+)\s*([+\-*/])\s*(\d+)/);
                    if (!mixed_parts) return '잘못된 혼합 문제입니다.';

                    const p1 = parseInt(mixed_parts[1]);
                    const op1 = mixed_parts[2];
                    const p2 = parseInt(mixed_parts[3]);
                    const op2 = mixed_parts[4];
                    const p3 = parseInt(mixed_parts[5]);
                    
                    explanation += `<div class="explanation-step"><strong>${p1} ${op1} ${p2} ${op2} ${p3}</strong>를 계산해봅시다.</div>`;
                    
                    // 연산 순서 결정
                    if ((op1 === '*' || op1 === '/') && (op2 === '+' || op2 === '-')) {
                        // 첫 번째 연산 먼저
                        const firstResult = eval(`${p1}${op1}${p2}`);
                        explanation += `<div class="explanation-step"><strong>1단계:</strong> 연산 순서에 따라 ${p1} ${op1} ${p2}를 먼저 계산합니다. 결과는 ${firstResult}입니다.</div>`;
                        const finalResult = eval(`${firstResult}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>2단계:</strong> 다음으로 ${firstResult} ${op2} ${p3}를 계산합니다. 결과는 ${finalResult}입니다.</div>`;
                    } else if ((op1 === '+' || op1 === '-') && (op2 === '*' || op2 === '/')) {
                        // 두 번째 연산 먼저
                        const secondResult = eval(`${p2}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>1단계:</strong> 연산 순서에 따라 ${p2} ${op2} ${p3}를 먼저 계산합니다. 결과는 ${secondResult}입니다.</div>`;
                        const finalResult = eval(`${p1}${op1}${secondResult}`);
                        explanation += `<div class="explanation-step"><strong>2단계:</strong> 다음으로 ${p1} ${op1} ${secondResult}를 계산합니다. 결과는 ${finalResult}입니다.</div>`;
                    } else {
                        // 순서대로 계산 (왼쪽부터)
                        const firstResult = eval(`${p1}${op1}${p2}`);
                        explanation += `<div class="explanation-step"><strong>1단계:</strong> 연산 순서에 따라 왼쪽부터 ${p1} ${op1} ${p2}를 계산합니다. 결과는 ${firstResult}입니다.</div>`;
                        const finalResult = eval(`${firstResult}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>2단계:</strong> 다음으로 ${firstResult} ${op2} ${p3}를 계산합니다. 결과는 ${finalResult}입니다.</div>`;
                    }
                    
                    explanation += `<div class="explanation-step">최종 결과는 ${question.answer}입니다.</div>`;
                    tip = '혼합 계산은 **곱셈과 나눗셈을 덧셈과 뺄셈보다 먼저** 계산하는 순서를 꼭 지켜야 합니다.';
            }

            return explanation + `<div class="explanation-step"><strong>💡 팁:</strong> ${tip}</div>`;
        }
        // --- 문제 풀이 로직 추가 끝 ---

        function goToNextQuestion() {
            currentQuestionIndex++;
            updateQuizUI();
        }

        function endQuiz() {
            const endTime = new Date();
            const timeTaken = Math.round((endTime - startTime) / 1000);
            const resultMessage = `${userName}님, 퀴즈가 끝났습니다! 총 ${score}점을 획득하셨습니다. ${timeTaken}초 걸렸습니다.`;
            alert(resultMessage);
            
            records.push({
                userName: userName,
                score: score,
                totalQuestions: questionsPerQuiz, // 문제 개수 저장
                date: new Date().toLocaleDateString('ko-KR'),
                time: timeTaken
            });
            localStorage.setItem('quizRecords', JSON.stringify(records));

            showMainMenu();
        }

        function showRecords() {
            showSection('recordsView');
            const recordsContainer = document.getElementById('recordsContainer');
            const recordsData = JSON.parse(localStorage.getItem('quizRecords')) || [];
            
            if (recordsData.length === 0) {
                recordsContainer.innerHTML = '<p>아직 퀴즈 기록이 없습니다.</p>';
                return;
            }

            // 문제 개수별로 기록 그룹화
            const groupedRecords = recordsData.reduce((acc, record) => {
                const key = record.totalQuestions || 10; // 기존 기록을 위해 기본값 10 설정
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(record);
                return acc;
            }, {});

            let recordsHTML = '';
            const questionCounts = [5, 10, 20, 30];

            questionCounts.forEach(count => {
                if (groupedRecords[count]) {
                    // 각 그룹별로 점수(내림차순), 시간(오름차순)으로 정렬
                    const sortedGroup = groupedRecords[count].sort((a, b) => {
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        return a.time - b.time;
                    });
                    
                    recordsHTML += `<h3>${count}문제 퀴즈 기록</h3>`;
                    recordsHTML += sortedGroup.map((record, index) => {
                        const totalScore = record.totalQuestions * 10;
                        return `
                            <div class="record-item">
                                <strong>${index + 1}. ${record.userName}</strong><br>
                                점수: ${record.score}점 (${totalScore}점 만점)<br>
                                걸린 시간: ${record.time}초<br>
                                날짜: ${record.date}
                            </div>
                        `;
                    }).join('');
                }
            });

            if (recordsHTML === '') {
                recordsContainer.innerHTML = '<p>아직 퀴즈 기록이 없습니다.</p>';
            } else {
                recordsContainer.innerHTML = recordsHTML;
            }
        }

        function resetRecords() {
            const password = prompt("기록을 초기화하려면 비밀번호를 입력하세요.");
            if (password === '0000') {
                localStorage.removeItem('quizRecords');
                records.length = 0;
                alert("퀴즈 기록이 성공적으로 초기화되었습니다.");
                showRecords();
            } else {
                alert("비밀번호가 틀렸습니다. 기록을 초기화할 수 없습니다.");
            }
        }

        function showAbout() {
            showSection('aboutView');
        }

        function showMultiplicationTable() {
            showSection('multiplicationTableView');
            const container = document.getElementById('multiplicationTableContainer');
            let tableHTML = '<h3>1단부터 9단까지</h3><table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            
            tableHTML += '<thead><tr style="background-color: #f2f2f2;">';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;"></th>';
            for(let j = 1; j <= 9; j++) {
                tableHTML += `<th style="border: 1px solid #ddd; padding: 10px;">${j}단</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            for (let i = 1; i <= 9; i++) {
                tableHTML += `<tr><td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">x ${i}</td>`;
                for (let j = 1; j <= 9; j++) {
                    tableHTML += `<td style="border: 1px solid #ddd; padding: 10px;">${i * j}</td>`;
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // 초기화
        showMainMenu();
    </script>
</body>
</html>
