<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë¹ ì˜ ìˆ˜í•™ í€´ì¦ˆ ì—¬í–‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-button {
            background-color: #5a2e9b;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .menu-button:hover {
            background-color: #4a257e;
            transform: translateY(-2px);
        }

        .quiz-section {
            display: none;
            text-align: left;
        }

        .question-box {
            background: #f7f7f7;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .question-display-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feedback {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
            min-height: 25px;
        }

        .correct {
            color: #28a745;
        }

        .wrong {
            color: #dc3545;
        }
        
        /* í’€ì´ ì„¤ëª… ìŠ¤íƒ€ì¼ */
        .explanation-box {
            background-color: #e9eef6;
            border-left: 5px solid #5a2e9b;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            border-radius: 8px;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            font-size: 1em;
            color: #333;
            line-height: 1.6;
        }

        .explanation-box h4 {
            margin-bottom: 10px;
            color: #4a257e;
        }
        
        .explanation-step {
            margin-bottom: 8px;
        }

        .score-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #eee;
            border-radius: 50px;
            margin-top: 15px;
        }

        .progress-bar {
            height: 15px;
            background-color: #5a2e9b;
            border-radius: 50px;
            transition: width 0.5s ease;
        }

        .about-section, .records-section, .multiplication-table-section {
            display: none;
            text-align: left;
            padding: 20px;
        }
        
        /* ì•± ì •ë³´ í˜ì´ì§€ ì •ë ¬ */
        #aboutView {
            display: none;
            flex-direction: column;
            align-items: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
            text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
        }
        
        .record-item {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .records-section h2, .about-section h2, .multiplication-table-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .records-section h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #4a257e;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .select-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .select-group {
            text-align: left;
        }
        
        /* í€´ì¦ˆ ì„¤ì • í˜ì´ì§€ ì •ë ¬ ë° ìŠ¤íƒ€ì¼ ê°œì„  */
        #quizSettingsView {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        #quizSettingsView .section-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 30px;
        }
        
        #quizSettingsView .select-container {
            width: 100%;
            max-width: 400px; /* ë“œë¡­ë‹¤ìš´ ê·¸ë£¹ì˜ ìµœëŒ€ ë„ˆë¹„ */
            margin-bottom: 30px;
        }
        
        #quizSettingsView .select-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        
        #quizSettingsView .select-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        #quizSettingsView .input-field {
            width: 100%;
        }
        
        #quizSettingsView .menu-button {
            width: 100%;
            max-width: 300px; /* ë²„íŠ¼ì˜ ìµœëŒ€ ë„ˆë¹„ */
            margin-bottom: 10px;
        }

        .vertical-problem {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2em;
            line-height: 1.2;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            width: fit-content;
        }

        .vertical-line {
            border-bottom: 2px solid #333;
            width: 100%;
        }

        .vertical-row {
            padding-right: 5px;
        }

        .operator {
            display: inline-block;
            margin-right: 5px;
        }
        
        .name-history {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: -5px;
            margin-bottom: 15px;
        }
        
        .name-tag {
            background-color: #e0e0e0;
            border-radius: 12px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .name-tag:hover {
            background-color: #d0d0d0;
        }
        
        .name-tag .delete-btn {
            background: transparent;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            color: #888;
            padding: 0;
            line-height: 1;
        }
        
        .name-tag .delete-btn:hover {
            color: #333;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ì•„ë¹ ì˜ ìˆ˜í•™ í€´ì¦ˆ ì—¬í–‰</h1>

        <div class="menu" id="mainMenu">
            <h2 class="section-title">ìœ¤í•˜! í•˜ìœ¤! ë…¸ë ¥í•´ì„œ ë³´ì—¬ì¤˜!!</h2>
            <label for="userName" style="font-weight: bold; margin-bottom: 5px; display: block;">í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</label>
            <input type="text" id="userName" class="input-field" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div id="nameHistoryContainer" class="name-history"></div>
            <button class="menu-button" onclick="goToSettings()">í€´ì¦ˆ ì‹œì‘</button>
            <button class="menu-button" onclick="showMultiplicationTable()">êµ¬êµ¬ë‹¨ í‘œ ë³´ê¸°</button>
            <button class="menu-button" onclick="showRecords()">ê¸°ë¡ ë³´ê¸°</button>
            <button class="menu-button" onclick="showAbout()">ì•± ì •ë³´</button>
        </div>

        <div class="quiz-section" id="quizSettingsView">
            <h2 id="settingsTitle" class="section-title"></h2>
            <div class="select-container">
                <div class="select-group">
                    <label for="problemType">ë¬¸ì œ ìœ í˜• ì„ íƒ:</label>
                    <select id="problemType" class="input-field">
                        <option value="ì „ì²´">ì „ì²´</option>
                        <option value="ë§ì…ˆ">ë§ì…ˆ</option>
                        <option value="ëº„ì…ˆ">ëº„ì…ˆ</option>
                        <option value="ê³±ì…ˆ">ê³±ì…ˆ</option>
                        <option value="ë‚˜ëˆ—ì…ˆ">ë‚˜ëˆ—ì…ˆ</option>
                        <option value="í˜¼í•©">í˜¼í•©</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="difficulty">ë‚œì´ë„ ì„ íƒ:</label>
                    <select id="difficulty" class="input-field">
                        <option value="F">F (ì•„ì£¼ ì‰¬ìš´)</option>
                        <option value="E">E (ì‰¬ì›€)</option>
                        <option value="D">D (ë³´í†µ)</option>
                        <option value="C">C (ì¡°ê¸ˆ ì–´ë ¤ì›€)</option>
                        <option value="B">B (ì–´ë ¤ì›€)</option>
                        <option value="A">A (ë§¤ìš° ì–´ë ¤ì›€)</option>
                        <option value="S">S (ìµœìƒê¸‰)</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="questionCount">ë¬¸ì œ ê°œìˆ˜ ì„ íƒ:</label>
                    <select id="questionCount" class="input-field">
                        <option value="5">5ê°œ</option>
                        <option value="10">10ê°œ</option>
                        <option value="20">20ê°œ</option>
                        <option value="30">30ê°œ</option>
                    </select>
                </div>
            </div>
            <button class="menu-button" onclick="beginQuiz()">í€´ì¦ˆ ì‹œì‘</button>
            <button class="menu-button" onclick="showMainMenu()">ë©”ì¸ ë©”ë‰´ë¡œ</button>
        </div>

        <div class="quiz-section" id="quizView">
            <h2 id="quizTitle" class="section-title"></h2>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="question-box">
                <div class="question-display-container">
                    <p id="questionText" class="question-text"></p>
                    <div id="verticalProblem" class="vertical-problem"></div>
                </div>
                
                <input type="number" id="answerInput" class="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
                
                <div class="button-container">
                    <button id="checkAnswerBtn" class="menu-button" onclick="checkAnswer()">ì •ë‹µ í™•ì¸</button>
                    <button id="nextQuestionBtn" class="menu-button" onclick="goToNextQuestion()" style="display: none;">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>

                <p id="feedback" class="feedback"></p>
                <div id="explanationBox" class="explanation-box"></div>
            </div>
            <div id="quizScore" class="score-display">ì ìˆ˜: 0</div>
            <button class="menu-button" onclick="showMainMenu()">ë©”ì¸ ë©”ë‰´ë¡œ</button>
        </div>

        <div class="quiz-section" id="recordsView">
            <h2 class="section-title">í€´ì¦ˆ ê¸°ë¡</h2>
            <div id="recordsContainer"></div>
            <button class="menu-button" onclick="showMainMenu()">ë©”ì¸ ë©”ë‰´ë¡œ</button>
            <button class="menu-button" onclick="resetRecords()">ê¸°ë¡ ë¦¬ì…‹</button>
        </div>

        <div class="quiz-section" id="aboutView">
            <h2 class="section-title" style="text-align: center;">ì•± ì •ë³´</h2>
            <p style="text-align: center; margin-bottom: 20px;">
                ì´ ì•±ì€ ìœ¤í•˜ ì™€ í•˜ìœ¤ì´ì˜ ì—°ì‚° ìˆ˜í•™ ì‹¤ë ¥ í–¥ìƒì„ ìœ„í•´ ë§Œë“¤ì–´ ì¡ŒìŠµë‹ˆë‹¤. ì•„ë¹ ëŠ” ë§ˆë¦¬ì…€, ìœ¤í•˜, í•˜ìœ¤ì´ ëª¨ë‘ë¥¼ ì‚¬ë‘í•©ë‹ˆë‹¤!^^
            </p>
            <button class="menu-button" style="display: block; margin: 0 auto;" onclick="showMainMenu()">ë©”ì¸ ë©”ë‰´ë¡œ</button>
        </div>

        <div class="quiz-section" id="multiplicationTableView">
            <h2 class="section-title">êµ¬êµ¬ë‹¨ í‘œ</h2>
            <div id="multiplicationTableContainer" style="text-align: center;"></div>
            <button class="menu-button" onclick="showMainMenu()">ë©”ì¸ ë©”ë‰´ë¡œ</button>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        let quizQuestions = [];
        let userName = '';
        const records = JSON.parse(localStorage.getItem('quizRecords')) || [];
        let questionsPerQuiz = 10;
        let startTime;
        let userNames = JSON.parse(localStorage.getItem('userNames')) || [];

        const difficultyRanges = {
            'F': { numMin: 1, numMax: 9, ops: ['+', '-', '*'] },
            'E': { numMin: 10, numMax: 99, ops: ['+', '-', '*'] },
            'D': { numMin: 10, numMax: 99, ops: ['+', '-', '*', '/'] },
            'C': { numMin: 100, numMax: 999, ops: ['+', '-', '*'] },
            'B': { numMin: 100, numMax: 999, ops: ['+', '-', '*', '/'] },
            'A': { numMin: 100, numMax: 9999, ops: ['+', '-', '*', '/'] },
            'S': { numMin: 1000, numMax: 99999, ops: ['+', '-', '*'] }
        };

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateRandomProblem(type, difficulty) {
            const config = difficultyRanges[difficulty];
            let problem = { text: '', answer: 0, type: type, grade: difficulty };

            if (type === 'ì „ì²´') {
                const availableTypes = ['ë§ì…ˆ', 'ëº„ì…ˆ', 'ê³±ì…ˆ', 'ë‚˜ëˆ—ì…ˆ', 'í˜¼í•©'];
                type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            }
            
            if (type === 'í˜¼í•©') {
                const op1 = config.ops[Math.floor(Math.random() * config.ops.length)];
                const op2 = config.ops[Math.floor(Math.random() * config.ops.length)];
                let n1, n2, n3;

                switch(difficulty) {
                    case 'F':
                    case 'E':
                    case 'D':
                        n1 = getRandomInt(1, 10);
                        n2 = getRandomInt(1, 10);
                        n3 = getRandomInt(1, 10);
                        break;
                    case 'C':
                    case 'B':
                        n1 = getRandomInt(10, 50);
                        n2 = getRandomInt(1, 20);
                        n3 = getRandomInt(1, 15);
                        break;
                    case 'A':
                        n1 = getRandomInt(50, 200);
                        n2 = getRandomInt(10, 50);
                        n3 = getRandomInt(5, 20);
                        break;
                    case 'S':
                        n1 = getRandomInt(100, 500);
                        n2 = getRandomInt(50, 100);
                        n3 = getRandomInt(10, 50);
                        break;
                }

                problem.text = `${n1} ${op1} ${n2} ${op2} ${n3}`;
                // ì•ˆì „í•˜ê²Œ answerë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ eval ì‚¬ìš©
                problem.answer = eval(problem.text);
                
                // í˜¼í•© ë¬¸ì œì—ì„œ ë‚˜ëˆ—ì…ˆì´ ì‚¬ìš©ë˜ê³  ì •ìˆ˜ê°€ ì•„ë‹ ê²½ìš°, ì •ìˆ˜ê°€ ë  ë•Œê¹Œì§€ ì¬ìƒì„±
                if (problem.text.includes('/') && problem.answer !== Math.floor(problem.answer)) {
                    return generateRandomProblem('í˜¼í•©', difficulty);
                }

            } else {
                let num1, num2;
                if (type === 'ë‚˜ëˆ—ì…ˆ') {
                    num2 = getRandomInt(2, 12);
                    num1 = num2 * getRandomInt(1, 12);
                    
                    if (difficulty === 'D') {
                       num2 = getRandomInt(2, 9);
                       num1 = num2 * getRandomInt(10, 20);
                    } else if (difficulty === 'B') {
                       num2 = getRandomInt(10, 20);
                       num1 = num2 * getRandomInt(10, 30);
                    } else if (difficulty === 'A') {
                       num2 = getRandomInt(20, 50);
                       num1 = num2 * getRandomInt(20, 50);
                    } else if (difficulty === 'S') {
                       num2 = getRandomInt(50, 100);
                       num1 = num2 * getRandomInt(50, 100);
                    }
                } else {
                    num1 = getRandomInt(config.numMin, config.numMax);
                    num2 = getRandomInt(config.numMin, config.numMax);
                }

                const operator = {
                    'ë§ì…ˆ': '+',
                    'ëº„ì…ˆ': '-',
                    'ê³±ì…ˆ': '*',
                    'ë‚˜ëˆ—ì…ˆ': '/'
                }[type];

                if (type === 'ëº„ì…ˆ' && num2 > num1) {
                    [num1, num2] = [num2, num1];
                }
                
                problem.text = `${num1} ${operator} ${num2}`;
                problem.answer = eval(problem.text);
            }
            return problem;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.quiz-section, .menu').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'flex';
            if (sectionId === 'quizView' || sectionId === 'multiplicationTableView' || sectionId === 'recordsView' || sectionId === 'aboutView') {
                document.getElementById(sectionId).style.flexDirection = 'column';
            }
        }

        function showMainMenu() {
            document.getElementById('userName').value = userName;
            showSection('mainMenu');
            updateNameHistory();
        }
        
        // ì´ë¦„ ëª©ë¡ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function updateNameHistory() {
            const container = document.getElementById('nameHistoryContainer');
            container.innerHTML = '';
            userNames.forEach(name => {
                const nameTag = document.createElement('div');
                nameTag.className = 'name-tag';
                nameTag.innerText = name;
                nameTag.onclick = () => {
                    document.getElementById('userName').value = name;
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerText = 'Ã—';
                deleteBtn.onclick = (event) => {
                    event.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                    deleteName(name);
                };
                
                nameTag.appendChild(deleteBtn);
                container.appendChild(nameTag);
            });
        }
        
        // ì´ë¦„ì„ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
        function deleteName(nameToDelete) {
            userNames = userNames.filter(name => name !== nameToDelete);
            localStorage.setItem('userNames', JSON.stringify(userNames));
            updateNameHistory();
        }

        function goToSettings() {
            userName = document.getElementById('userName').value.trim();
            if (userName === '') {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ìƒˆë¡œìš´ ì´ë¦„ì´ë©´ ì¶”ê°€í•˜ê³  ì €ì¥
            if (!userNames.includes(userName)) {
                userNames.push(userName);
                localStorage.setItem('userNames', JSON.stringify(userNames));
            }

            document.getElementById('settingsTitle').innerText = `${userName}ë‹˜, í€´ì¦ˆ ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”!`;
            showSection('quizSettingsView');
        }

        function beginQuiz() {
            const selectedType = document.getElementById('problemType').value;
            const selectedDifficulty = document.getElementById('difficulty').value;
            questionsPerQuiz = parseInt(document.getElementById('questionCount').value);

            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = generateQuizQuestions(selectedType, selectedDifficulty);
            startTime = new Date();
            updateQuizUI();
            showSection('quizView');
            document.getElementById('quizTitle').innerText = `${userName}ë‹˜ì˜ í€´ì¦ˆ (${selectedDifficulty} ë‚œì´ë„)`;
        }

        function generateQuizQuestions(type, difficulty) {
            const questions = [];
            for(let i = 0; i < questionsPerQuiz; i++) {
                questions.push(generateRandomProblem(type, difficulty));
            }
            return questions;
        }
        
        function createVerticalProblemHTML(questionText) {
            const parts = questionText.split(/([+\-*/])/);
            const num1 = parts[0].trim();
            const operator = parts[1].trim();
            const num2 = parts[2].trim();
            
            let html = '';

            if (operator === '/') {
                // ë‚˜ëˆ—ì…ˆì„ ìœ„í•œ íŠ¹ë³„í•œ ì„¸ë¡œì…ˆ
                html = `
                    <div class="vertical-row">${num1}</div>
                    <div class="vertical-row"><span class="operator">Ã·</span>${num2}</div>
                    <div class="vertical-line"></div>
                `;
            } else {
                // ê¸°ì¡´ì˜ ë§ì…ˆ, ëº„ì…ˆ, ê³±ì…ˆ ì„¸ë¡œì…ˆ
                html = `
                    <div class="vertical-row">${num1}</div>
                    <div class="vertical-row"><span class="operator">${operator}</span>${num2}</div>
                    <div class="vertical-line"></div>
                `;
            }
            
            return html;
        }

        function updateQuizUI() {
            if (currentQuestionIndex < quizQuestions.length) {
                const currentQuestion = quizQuestions[currentQuestionIndex];
                document.getElementById('questionText').innerText = currentQuestion.text;
                
                const verticalProblemDiv = document.getElementById('verticalProblem');
                // ë‚˜ëˆ—ì…ˆ ë¬¸ì œì—ë„ ì„¸ë¡œì…ˆì„ ì ìš©
                if (['ë§ì…ˆ', 'ëº„ì…ˆ', 'ê³±ì…ˆ', 'ë‚˜ëˆ—ì…ˆ'].includes(currentQuestion.type)) {
                    verticalProblemDiv.innerHTML = createVerticalProblemHTML(currentQuestion.text);
                    verticalProblemDiv.style.display = 'flex';
                } else {
                    verticalProblemDiv.innerHTML = '';
                    verticalProblemDiv.style.display = 'none';
                }

                document.getElementById('answerInput').value = '';
                document.getElementById('feedback').innerText = '';
                document.getElementById('explanationBox').style.display = 'none'; // ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ë©´ í’€ì´ ìˆ¨ê¹€
                document.getElementById('quizScore').innerText = `ì ìˆ˜: ${score}`;
                
                document.getElementById('checkAnswerBtn').style.display = 'block';
                document.getElementById('nextQuestionBtn').style.display = 'none';

                const progress = (currentQuestionIndex / quizQuestions.length) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            } else {
                endQuiz();
            }
        }

        function checkAnswer() {
            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const currentQuestion = quizQuestions[currentQuestionIndex];
            const feedbackElement = document.getElementById('feedback');
            const explanationBox = document.getElementById('explanationBox');
            
            if (userAnswer === currentQuestion.answer) {
                feedbackElement.innerText = 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ˜Š';
                feedbackElement.className = 'feedback correct';
                score += 10;
                explanationBox.style.display = 'none';
            } else {
                feedbackElement.innerText = `ì•„ì‰½ë„¤ìš”. ì •ë‹µì€ ${currentQuestion.answer}ì…ë‹ˆë‹¤.`;
                feedbackElement.className = 'feedback wrong';
                explanationBox.innerHTML = `<h4>ë¬¸ì œ í’€ì´</h4>${generateExplanation(currentQuestion)}`;
                explanationBox.style.display = 'block';
            }

            document.getElementById('checkAnswerBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'block';
        }

        function generateExplanation(question) {
            const parts = question.text.split(/([+\-*/])/);
            const num1 = parseFloat(parts[0].trim());
            const operator = parts[1].trim();
            const num2 = parseFloat(parts[2].trim());
            
            let explanation = '';
            let tip = '';

            switch (operator) {
                case '+':
                    let n1_temp = num1;
                    let n2_temp = num2;
                    let sum = 0;
                    let carry = 0;
                    let i = 0;

                    explanation += `<div class="explanation-step"><strong>${num1} + ${num2}</strong>ë¥¼ ê³„ì‚°í•´ë´…ì‹œë‹¤.</div>`;

                    while (n1_temp > 0 || n2_temp > 0 || carry > 0) {
                        const d1 = n1_temp % 10;
                        const d2 = n2_temp % 10;
                        const digitSum = d1 + d2 + carry;
                        
                        explanation += `<div class="explanation-step"><strong>${10**i}ì˜ ìë¦¬:</strong> ${d1} + ${d2} + ${carry}(ì˜¬ë¦¼) = ${digitSum}ì…ë‹ˆë‹¤.</div>`;

                        if (digitSum >= 10) {
                            carry = Math.floor(digitSum / 10);
                            explanation += `<div class="explanation-step"><strong>${10**(i+1)}ì˜ ìë¦¬ë¡œ ${carry}ë¥¼ ì˜¬ë¦½ë‹ˆë‹¤.</strong></div>`;
                        } else {
                            carry = 0;
                        }
                        
                        sum = (digitSum % 10) * (10**i) + sum;
                        n1_temp = Math.floor(n1_temp / 10);
                        n2_temp = Math.floor(n2_temp / 10);
                        i++;
                    }
                    explanation += `<div class="explanation-step">ìµœì¢… ê²°ê³¼ëŠ” ${sum}ì…ë‹ˆë‹¤.</div>`;
                    tip = 'ë§ì…ˆì€ ì˜¤ë¥¸ìª½ë¶€í„° ì‹œì‘í•´ì„œ í•œ ìë¦¬ì”© ë”í•˜ê³ , í•©ì´ 10ì´ ë„˜ìœ¼ë©´ ë‹¤ìŒ ìë¦¬ë¡œ ì˜¬ë¦¼í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.';
                    break;
                case '-':
                    let n1_str = num1.toString();
                    let n2_str = num2.toString();
                    let result_str = '';
                    let borrow = 0;

                    const maxLength = Math.max(n1_str.length, n2_str.length);
                    n1_str = n1_str.padStart(maxLength, '0');
                    n2_str = n2_str.padStart(maxLength, '0');
                    
                    explanation += `<div class="explanation-step"><strong>${num1} - ${num2}</strong>ë¥¼ ê³„ì‚°í•´ë´…ì‹œë‹¤.</div>`;
                    
                    for (let i = maxLength - 1; i >= 0; i--) {
                        let d1 = parseInt(n1_str[i]);
                        let d2 = parseInt(n2_str[i]);
                        
                        let diff = d1 - d2 - borrow;
                        
                        explanation += `<div class="explanation-step"><strong>${10**(maxLength - 1 - i)}ì˜ ìë¦¬:</strong> ${d1} - ${d2} - ${borrow}(ë°›ì•„ë‚´ë¦¼) = ${diff}ì…ë‹ˆë‹¤.</div>`;
                        
                        if (diff < 0) {
                            diff += 10;
                            borrow = 1;
                            explanation += `<div class="explanation-step"><strong>ì™¼ìª½ ìë¦¬ì—ì„œ 10ì„ ë°›ì•„ë‚´ë¦½ë‹ˆë‹¤.</strong></div>`;
                        } else {
                            borrow = 0;
                        }
                        result_str = diff.toString() + result_str;
                    }
                    
                    explanation += `<div class="explanation-step">ìµœì¢… ê²°ê³¼ëŠ” ${question.answer}ì…ë‹ˆë‹¤.</div>`;
                    tip = 'ëº„ì…ˆì€ ìë¦¬ê°€ ë¶€ì¡±í•  ë•Œ ì™¼ìª½ ìë¦¬ì—ì„œ 10ì„ ë¹Œë ¤ì˜¤ëŠ” **ë°›ì•„ë‚´ë¦¼**ì„ ì •í™•íˆ í•´ì•¼ í•©ë‹ˆë‹¤.';
                    break;
                case '*':
                    const n1_str_m = num1.toString();
                    const n2_str_m = num2.toString();
                    
                    explanation += `<div class="explanation-step"><strong>${num1} x ${num2}</strong>ë¥¼ ê³„ì‚°í•´ë´…ì‹œë‹¤.</div>`;
                    
                    for (let i = n2_str_m.length - 1; i >= 0; i--) {
                        const currentDigit = parseInt(n2_str_m[i]);
                        const partialProduct = num1 * currentDigit;
                        
                        explanation += `<div class="explanation-step"><strong>1ë‹¨ê³„:</strong> ${num1} x ${currentDigit} = ${partialProduct}ì…ë‹ˆë‹¤.</div>`;
                    }
                    
                    explanation += `<div class="explanation-step"><strong>2ë‹¨ê³„:</strong> ê° ê³±ì…ˆ ê²°ê³¼ë¥¼ ìë¦¬ì— ë§ì¶° ë”í•©ë‹ˆë‹¤.</div>`;
                    explanation += `<div class="explanation-step">ìµœì¢… ê²°ê³¼ëŠ” ${question.answer}ì…ë‹ˆë‹¤.</div>`;
                    tip = 'ê³±ì…ˆì€ ê³±í•˜ëŠ” ìˆ˜ì˜ ê° ìë¦¬ ìˆ˜ì™€ ìˆœì„œëŒ€ë¡œ ê³±í•œ ë’¤, ìë¦¬ë¥¼ ë§ì¶° ë”í•˜ëŠ” ê³¼ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
                    break;
                case '/':
                    const remainder = num1 % num2;
                    const quotient = Math.floor(num1 / num2);
                    explanation = `
                        <div class="explanation-step"><strong>${num1} Ã· ${num2}</strong>ë¥¼ ê³„ì‚°í•´ë´…ì‹œë‹¤.</div>
                        <div class="explanation-step"><strong>1ë‹¨ê³„:</strong> ${num1} ì•ˆì— ${num2}ê°€ ëª‡ ë²ˆ ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</div>
                        <div class="explanation-step"><strong>2ë‹¨ê³„:</strong> ëª«ì€ ${quotient}ì´ê³ , ë‚˜ë¨¸ì§€ëŠ” ${remainder}ì…ë‹ˆë‹¤.</div>
                        <div class="explanation-step">ë”°ë¼ì„œ ${num1} Ã· ${num2}ì˜ ì •ë‹µì€ ëª«ì¸ ${question.answer}ì…ë‹ˆë‹¤.</div>
                    `;
                    tip = 'ë‚˜ëˆ—ì…ˆì€ ëª«ê³¼ ë‚˜ë¨¸ì§€ë¥¼ ì •í™•íˆ êµ¬ë¶„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                    break;
                default: // í˜¼í•© ê³„ì‚°
                    // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ì—°ì‚°ìì™€ ìˆ«ìë¥¼ ë¶„ë¦¬
                    const mixed_parts = question.text.match(/(\d+)\s*([+\-*/])\s*(\d+)\s*([+\-*/])\s*(\d+)/);
                    if (!mixed_parts) return 'ì˜ëª»ëœ í˜¼í•© ë¬¸ì œì…ë‹ˆë‹¤.';

                    const p1 = parseInt(mixed_parts[1]);
                    const op1 = mixed_parts[2];
                    const p2 = parseInt(mixed_parts[3]);
                    const op2 = mixed_parts[4];
                    const p3 = parseInt(mixed_parts[5]);
                    
                    explanation += `<div class="explanation-step"><strong>${p1} ${op1} ${p2} ${op2} ${p3}</strong>ë¥¼ ê³„ì‚°í•´ë´…ì‹œë‹¤.</div>`;
                    
                    // ì—°ì‚° ìˆœì„œ ê²°ì •
                    if ((op1 === '*' || op1 === '/') && (op2 === '+' || op2 === '-')) {
                        // ì²« ë²ˆì§¸ ì—°ì‚° ë¨¼ì €
                        const firstResult = eval(`${p1}${op1}${p2}`);
                        explanation += `<div class="explanation-step"><strong>1ë‹¨ê³„:</strong> ì—°ì‚° ìˆœì„œì— ë”°ë¼ ${p1} ${op1} ${p2}ë¥¼ ë¨¼ì € ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${firstResult}ì…ë‹ˆë‹¤.</div>`;
                        const finalResult = eval(`${firstResult}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>2ë‹¨ê³„:</strong> ë‹¤ìŒìœ¼ë¡œ ${firstResult} ${op2} ${p3}ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${finalResult}ì…ë‹ˆë‹¤.</div>`;
                    } else if ((op1 === '+' || op1 === '-') && (op2 === '*' || op2 === '/')) {
                        // ë‘ ë²ˆì§¸ ì—°ì‚° ë¨¼ì €
                        const secondResult = eval(`${p2}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>1ë‹¨ê³„:</strong> ì—°ì‚° ìˆœì„œì— ë”°ë¼ ${p2} ${op2} ${p3}ë¥¼ ë¨¼ì € ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${secondResult}ì…ë‹ˆë‹¤.</div>`;
                        const finalResult = eval(`${p1}${op1}${secondResult}`);
                        explanation += `<div class="explanation-step"><strong>2ë‹¨ê³„:</strong> ë‹¤ìŒìœ¼ë¡œ ${p1} ${op1} ${secondResult}ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${finalResult}ì…ë‹ˆë‹¤.</div>`;
                    } else {
                        // ìˆœì„œëŒ€ë¡œ ê³„ì‚° (ì™¼ìª½ë¶€í„°)
                        const firstResult = eval(`${p1}${op1}${p2}`);
                        explanation += `<div class="explanation-step"><strong>1ë‹¨ê³„:</strong> ì—°ì‚° ìˆœì„œì— ë”°ë¼ ì™¼ìª½ë¶€í„° ${p1} ${op1} ${p2}ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${firstResult}ì…ë‹ˆë‹¤.</div>`;
                        const finalResult = eval(`${firstResult}${op2}${p3}`);
                        explanation += `<div class="explanation-step"><strong>2ë‹¨ê³„:</strong> ë‹¤ìŒìœ¼ë¡œ ${firstResult} ${op2} ${p3}ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” ${finalResult}ì…ë‹ˆë‹¤.</div>`;
                    }
                    
                    explanation += `<div class="explanation-step">ìµœì¢… ê²°ê³¼ëŠ” ${question.answer}ì…ë‹ˆë‹¤.</div>`;
                    tip = 'í˜¼í•© ê³„ì‚°ì€ **ê³±ì…ˆê³¼ ë‚˜ëˆ—ì…ˆì„ ë§ì…ˆê³¼ ëº„ì…ˆë³´ë‹¤ ë¨¼ì €** ê³„ì‚°í•˜ëŠ” ìˆœì„œë¥¼ ê¼­ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.';
            }

            return explanation + `<div class="explanation-step"><strong>ğŸ’¡ íŒ:</strong> ${tip}</div>`;
        }
        // --- ë¬¸ì œ í’€ì´ ë¡œì§ ì¶”ê°€ ë ---

        function goToNextQuestion() {
            currentQuestionIndex++;
            updateQuizUI();
        }

        function endQuiz() {
            const endTime = new Date();
            const timeTaken = Math.round((endTime - startTime) / 1000);
            const resultMessage = `${userName}ë‹˜, í€´ì¦ˆê°€ ëë‚¬ìŠµë‹ˆë‹¤! ì´ ${score}ì ì„ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤. ${timeTaken}ì´ˆ ê±¸ë ¸ìŠµë‹ˆë‹¤.`;
            alert(resultMessage);
            
            records.push({
                userName: userName,
                score: score,
                totalQuestions: questionsPerQuiz, // ë¬¸ì œ ê°œìˆ˜ ì €ì¥
                date: new Date().toLocaleDateString('ko-KR'),
                time: timeTaken
            });
            localStorage.setItem('quizRecords', JSON.stringify(records));

            showMainMenu();
        }

        function showRecords() {
            showSection('recordsView');
            const recordsContainer = document.getElementById('recordsContainer');
            const recordsData = JSON.parse(localStorage.getItem('quizRecords')) || [];
            
            if (recordsData.length === 0) {
                recordsContainer.innerHTML = '<p>ì•„ì§ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ë¬¸ì œ ê°œìˆ˜ë³„ë¡œ ê¸°ë¡ ê·¸ë£¹í™”
            const groupedRecords = recordsData.reduce((acc, record) => {
                const key = record.totalQuestions || 10; // ê¸°ì¡´ ê¸°ë¡ì„ ìœ„í•´ ê¸°ë³¸ê°’ 10 ì„¤ì •
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(record);
                return acc;
            }, {});

            let recordsHTML = '';
            const questionCounts = [5, 10, 20, 30];

            questionCounts.forEach(count => {
                if (groupedRecords[count]) {
                    // ê° ê·¸ë£¹ë³„ë¡œ ì ìˆ˜(ë‚´ë¦¼ì°¨ìˆœ), ì‹œê°„(ì˜¤ë¦„ì°¨ìˆœ)ìœ¼ë¡œ ì •ë ¬
                    const sortedGroup = groupedRecords[count].sort((a, b) => {
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        return a.time - b.time;
                    });
                    
                    recordsHTML += `<h3>${count}ë¬¸ì œ í€´ì¦ˆ ê¸°ë¡</h3>`;
                    recordsHTML += sortedGroup.map((record, index) => {
                        const totalScore = record.totalQuestions * 10;
                        return `
                            <div class="record-item">
                                <strong>${index + 1}. ${record.userName}</strong><br>
                                ì ìˆ˜: ${record.score}ì  (${totalScore}ì  ë§Œì )<br>
                                ê±¸ë¦° ì‹œê°„: ${record.time}ì´ˆ<br>
                                ë‚ ì§œ: ${record.date}
                            </div>
                        `;
                    }).join('');
                }
            });

            if (recordsHTML === '') {
                recordsContainer.innerHTML = '<p>ì•„ì§ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                recordsContainer.innerHTML = recordsHTML;
            }
        }

        function resetRecords() {
            const password = prompt("ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (password === '0000') {
                localStorage.removeItem('quizRecords');
                records.length = 0;
                alert("í€´ì¦ˆ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                showRecords();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ê¸°ë¡ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        function showAbout() {
            showSection('aboutView');
        }

        function showMultiplicationTable() {
            showSection('multiplicationTableView');
            const container = document.getElementById('multiplicationTableContainer');
            let tableHTML = '<h3>1ë‹¨ë¶€í„° 9ë‹¨ê¹Œì§€</h3><table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            
            tableHTML += '<thead><tr style="background-color: #f2f2f2;">';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;"></th>';
            for(let j = 1; j <= 9; j++) {
                tableHTML += `<th style="border: 1px solid #ddd; padding: 10px;">${j}ë‹¨</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            for (let i = 1; i <= 9; i++) {
                tableHTML += `<tr><td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">x ${i}</td>`;
                for (let j = 1; j <= 9; j++) {
                    tableHTML += `<td style="border: 1px solid #ddd; padding: 10px;">${i * j}</td>`;
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // ì´ˆê¸°í™”
        showMainMenu();
    </script>
</body>
</html>
